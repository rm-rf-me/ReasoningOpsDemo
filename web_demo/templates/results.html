<!DOCTYPE html>
<html>
<head>
    <title>推理结果展示</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .results-container {
            height: 100vh;
        }
        .meta-section {
            background: #f5f7fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event-section {
            margin-bottom: 30px;
            border: 1px solid #e4e7ed;
            border-radius: 8px;
        }
        .batch-section {
            margin: 15px;
            padding: 15px;
            background: #fafafa;
            border-radius: 6px;
        }
        .alarm-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #409eff;
        }
        .thinking-content {
            background: #f0f9ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .api-call {
            background: #fff7e6;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            font-family: monospace;
        }
        .comment-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e4e7ed;
        }
        .comment-item {
            background: #f5f7fa;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .expandable-content {
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s;
        }
        .expandable-content.expanded {
            max-height: none;
        }
        .config-dialog {
            max-width: 800px;
        }
        .config-dialog .el-message-box__content {
            max-height: 500px;
            overflow-y: auto;
        }
        .engineer-input {
            width: 400px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
        }
        .alarm-list-section {
            margin-bottom: 20px;
            min-height: 200px;
        }
        .alarm-list-empty {
            text-align: center;
            padding: 40px;
            color: #909399;
            background: #fafafa;
            border-radius: 8px;
            border: 2px dashed #dcdfe6;
        }
        .import-dialog-content {
            padding: 20px 0;
        }
        .upload-area {
            margin: 20px 0;
        }
        .file-info {
            margin-top: 20px;
        }
        .file-details p {
            margin: 8px 0;
            color: #606266;
        }
        .el-main {
            overflow-y: auto;
            height: calc(100vh - 60px);
        }
        .reasoning-flow-container {
            margin: 15px 0;
        }
        .reasoning-step {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #409eff;
        }
        .thinking-step {
            background: #f0f9ff;
            border-left-color: #409eff;
        }
        .action-step {
            background: #fff7e6;
            border-left-color: #e6a23c;
        }
        .result-step {
            background: #f0f9ff;
            border-left-color: #67c23a;
        }
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #303133;
        }
        .step-header i {
            margin-right: 8px;
            font-size: 16px;
        }
        .step-title {
            font-size: 14px;
        }
        .step-content {
            line-height: 1.6;
            color: #606266;
        }
        .json-action {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .api-result {
            background: #f0f9ff;
            border: 1px solid #b3d8ff;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="app" class="results-container">
        <el-container>
            <!-- 侧边栏 -->
            <el-aside :width="isCollapse ? '64px' : '240px'">
                <div class="aside-logo" @click="toggleCollapse">
                    <i class="el-icon-monitor"></i>
                    <span v-show="!isCollapse">数据中心智能运维系统</span>
                </div>
                <el-menu
                    :default-active="activeMenu"
                    class="aside-menu"
                    background-color="#304156"
                    text-color="#bfcbd9"
                    active-text-color="#409EFF"
                    :collapse="isCollapse"
                    :collapse-transition="false">
                    <el-menu-item index="1" @click="handleMenuSelect('1')">
                        <i class="el-icon-warning-outline"></i>
                        <span slot="title">告警处理</span>
                    </el-menu-item>
                    <el-menu-item index="2" @click="handleMenuSelect('2')">
                        <i class="el-icon-share"></i>
                        <span slot="title">管理拓扑</span>
                    </el-menu-item>
                    <el-menu-item index="3" @click="handleMenuSelect('3')">
                        <i class="el-icon-connection"></i>
                        <span slot="title">管理设备API</span>
                    </el-menu-item>
                    <el-menu-item index="4" @click="handleMenuSelect('4')">
                        <i class="el-icon-set-up"></i>
                        <span slot="title">管理BA规则</span>
                    </el-menu-item>
                    <el-menu-item index="5" @click="handleMenuSelect('5')">
                        <i class="el-icon-document"></i>
                        <span slot="title">结果展示</span>
                    </el-menu-item>
                </el-menu>
            </el-aside>

            <!-- 主容器 -->
            <el-container>
                <!-- 头部 -->
                <el-header>
                    <div class="header-wrapper">
                        <div class="header-left">
                            <h2>推理结果分析</h2>
                        </div>
                        <div class="header-right">
                            <div class="engineer-input-container">
                                <el-input 
                                    v-model="engineerName" 
                                    placeholder="如需添加评论请输入工程师昵称"
                                    class="engineer-input"
                                    size="medium">
                                    <template slot="prepend">工程师:</template>
                                </el-input>
                                <el-button 
                                    type="primary" 
                                    icon="el-icon-check"
                                    @click="confirmEngineerName"
                                    size="medium"
                                    class="engineer-confirm-btn">
                                    确认
                                </el-button>
                            </div>
                            <el-divider direction="vertical"></el-divider>
                            <div class="action-buttons">
                                <el-button type="primary" icon="el-icon-folder-opened" size="medium" @click="showImportDialog">导入数据</el-button>
                                <el-button type="success" icon="el-icon-upload2" size="medium" @click="exportResults" :disabled="!resultData">导出结果</el-button>
                                <el-button type="info" icon="el-icon-setting" size="medium">设置</el-button>
                            </div>
                        </div>
                    </div>
                </el-header>
                
                <!-- 主体内容 -->
                <el-main class="main-content">
                    <!-- 空状态 -->
                    <div v-if="!resultData" class="empty-state">
                        <i class="el-icon-document"></i>
                        <h3>暂无数据</h3>
                        <p>请点击右上角的"导入数据"按钮来加载推理结果文件</p>
                        <el-button type="primary" icon="el-icon-folder-opened" @click="showImportDialog">导入数据</el-button>
                    </div>

                    <!-- 元数据和统计信息 -->
                    <div v-if="resultData" class="meta-section">
                        <h3><i class="el-icon-info"></i> 元数据信息</h3>
                        <el-row :gutter="20">
                            <el-col :span="6">
                                <strong><i class="el-icon-cpu"></i> 模型类型:</strong> 
                                <span v-text="resultData.meta_data.model_type"></span>
                            </el-col>
                            <el-col :span="6">
                                <strong><i class="el-icon-edit-outline"></i> 提示词类型:</strong> 
                                <span v-text="resultData.meta_data.prompt_key || '默认'"></span>
                            </el-col>
                            <el-col :span="6">
                                <strong><i class="el-icon-monitor"></i> 窗口大小:</strong> 
                                <span v-text="resultData.meta_data.window_size || 'N/A'"></span>
                            </el-col>
                            <el-col :span="6">
                                <el-button size="medium" @click="showConfig" icon="el-icon-setting" type="primary">
                                    查看配置
                                </el-button>
                            </el-col>
                        </el-row>
                        
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h4><i class="el-icon-data-analysis"></i> 输入统计</h4>
                                <p><strong>总告警数:</strong> <span v-text="resultData.summary.input_stats.total_alarms"></span></p>
                                <p><strong>总事件数:</strong> <span v-text="resultData.summary.input_stats.total_events"></span></p>
                                <p><strong>自收敛数:</strong> <span v-text="resultData.summary.input_stats.ground_truth_self_convergence"></span></p>
                                <p><strong>他收敛数:</strong> <span v-text="resultData.summary.input_stats.ground_truth_other_convergence"></span></p>
                            </div>
                            <div class="summary-card">
                                <h4><i class="el-icon-pie-chart"></i> 原始评估</h4>
                                <p><strong>总体准确率:</strong> <span :data-accuracy="getAccuracyLevel(resultData.summary.evaluation_stats.overall_accuracy)" v-text="formatAccuracy(resultData.summary.evaluation_stats.overall_accuracy)"></span></p>
                                <p><strong>自收敛准确率:</strong> <span :data-accuracy="getAccuracyLevel(resultData.summary.evaluation_stats.self_convergence_accuracy)" v-text="formatAccuracy(resultData.summary.evaluation_stats.self_convergence_accuracy)"></span></p>
                                <p><strong>他收敛准确率:</strong> <span :data-accuracy="getAccuracyLevel(resultData.summary.evaluation_stats.other_convergence_accuracy)" v-text="formatAccuracy(resultData.summary.evaluation_stats.other_convergence_accuracy)"></span></p>
                                <p><strong>已处理告警:</strong> <span v-text="resultData.summary.evaluation_stats.processed_alarms"></span></p>
                                <p><strong>正确预测:</strong> <span v-text="resultData.summary.evaluation_stats.correct_predictions"></span></p>
                                <p><strong>错误预测:</strong> <span v-text="resultData.summary.evaluation_stats.incorrect_predictions"></span></p>
                                <p><strong>正确自收敛:</strong> <span v-text="resultData.summary.evaluation_stats.correct_self_convergence"></span></p>
                                <p><strong>正确他收敛:</strong> <span v-text="resultData.summary.evaluation_stats.correct_other_convergence"></span></p>
                            </div>
                            <div class="summary-card">
                                <h4><i class="el-icon-s-data"></i> 聚类评估</h4>
                                <p><strong>总体准确率:</strong> <span :data-accuracy="getAccuracyLevel(resultData.summary.cluster_evaluation_stats.overall_accuracy)" v-text="formatAccuracy(resultData.summary.cluster_evaluation_stats.overall_accuracy)"></span></p>
                                <p><strong>自收敛准确率:</strong> <span :data-accuracy="getAccuracyLevel(resultData.summary.cluster_evaluation_stats.self_accuracy)" v-text="formatAccuracy(resultData.summary.cluster_evaluation_stats.self_accuracy)"></span></p>
                                <p><strong>他收敛准确率:</strong> <span :data-accuracy="getAccuracyLevel(resultData.summary.cluster_evaluation_stats.other_accuracy)" v-text="formatAccuracy(resultData.summary.cluster_evaluation_stats.other_accuracy)"></span></p>
                                <p><strong>已处理告警:</strong> <span v-text="resultData.summary.cluster_evaluation_stats.processed_alarms"></span></p>
                                <p><strong>正确预测:</strong> <span v-text="resultData.summary.cluster_evaluation_stats.correct_predictions"></span></p>
                                <p><strong>错误预测:</strong> <span v-text="resultData.summary.cluster_evaluation_stats.incorrect_predictions"></span></p>
                                <p><strong>真实自收敛:</strong> <span v-text="resultData.summary.cluster_evaluation_stats.ground_self_convergence"></span></p>
                                <p><strong>真实他收敛:</strong> <span v-text="resultData.summary.cluster_evaluation_stats.ground_other_convergence"></span></p>
                                <p><strong>正确自收敛:</strong> <span v-text="resultData.summary.cluster_evaluation_stats.correct_self_convergence"></span></p>
                                <p><strong>正确他收敛:</strong> <span v-text="resultData.summary.cluster_evaluation_stats.correct_other_convergence"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- 事件和告警信息列表 -->
                    <div v-if="resultData" class="events-alarms-section">
                        <el-card class="events-card">
                            <div slot="header">
                                <span><i class="el-icon-warning-outline"></i> 事件和告警信息</span>
                                <el-button style="float: right; padding: 3px 0" type="text" @click="expandAllEvents">
                                    <span v-if="!allEventsExpanded">全部展开</span><span v-else>全部收起</span>
                                </el-button>
                            </div>
                            
                            <div v-if="resultData.events.length === 0" class="events-empty">
                                <i class="el-icon-document"></i>
                                <p>暂无事件信息</p>
                            </div>
                            
                            <div v-else class="events-list">
                                <!-- 事件列表 -->
                                <div v-for="(event, eventIndex) in resultData.events" :key="eventIndex" class="event-item">
                                    <div class="event-header" @click="toggleEvent(eventIndex)">
                                        <div class="event-info">
                                            <i class="el-icon-document"></i>
                                            <span class="event-name" v-text="'事件 ' + (eventIndex + 1) + ': ' + event.event_id"></span>
                                        </div>
                                        <div class="event-stats">
                                            <el-tag size="small" type="info">
                                                <i class="el-icon-bell"></i> <span v-text="event.alarms.length + ' 个告警'"></span>
                                            </el-tag>
                                            <el-tag size="small" :type="getEventAccuracyType(event)">
                                                <i class="el-icon-check"></i> <span v-text="getEventAccuracy(event) + '% 正确率'"></span>
                                            </el-tag>
                                            <i :class="expandedEvents.includes(eventIndex) ? 'el-icon-arrow-up' : 'el-icon-arrow-down'" class="expand-icon"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- 事件内的告警列表 -->
                                    <div v-show="expandedEvents.includes(eventIndex)" class="alarms-container">
                                        <div v-for="(alarm, alarmIndex) in event.alarms" :key="alarmIndex" class="alarm-item">
                                            <div class="alarm-header" @click="toggleAlarm(eventIndex, alarmIndex)">
                                                <div class="alarm-info">
                                                    <i class="el-icon-warning"></i>
                                                    <span class="alarm-id" v-text="alarm.alarm_id"></span>
                                                    <span class="alarm-time" v-text="alarm.alarm_time"></span>
                                                </div>
                                                <div class="alarm-content-preview" v-text="alarm.input.alarm_content"></div>
                                                <div class="alarm-status">
                                                    <el-tag size="small" :type="getCorrectTagType(alarm)">
                                                        <span v-text="getCorrectText(alarm)"></span>
                                                    </el-tag>
                                                    <el-tag size="small" type="primary">
                                                        <span v-text="alarm.output.model_answer_id"></span>
                                                    </el-tag>
                                                    <i :class="expandedAlarms[eventIndex] && expandedAlarms[eventIndex].includes(alarmIndex) ? 'el-icon-arrow-up' : 'el-icon-arrow-down'" class="expand-icon"></i>
                                                </div>
                                            </div>
                                                    
                                            <!-- 告警详细信息 -->
                                            <div v-show="expandedAlarms[eventIndex] && expandedAlarms[eventIndex].includes(alarmIndex)" class="alarm-details">
                                                <!-- 推理过程 -->
                                                <div v-if="alarm.output.thinking" class="detail-section">
                                                    <h4><i class="el-icon-cpu"></i> 推理过程</h4>
                                                    <div class="content-box thinking-content">
                                                        <div v-html="formatThinking(alarm.output.thinking)"></div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 详细推理流程 -->
                                                <div v-if="hasReasoningFlow(alarm)" class="detail-section">
                                                    <h4><i class="el-icon-s-operation"></i> 详细推理流程</h4>
                                                    <div class="reasoning-flow-container">
                                                        <el-timeline>
                                                            <el-timeline-item 
                                                                v-for="(step, stepIndex) in getReasoningFlowSteps(alarm)" 
                                                                :key="stepIndex"
                                                                :icon="getStepIcon(getStepType(step))"
                                                                :type="getStepType(step) === 'result' ? 'success' : (getStepType(step) === 'action' ? 'primary' : 'info')"
                                                                :timestamp="'步骤 ' + (stepIndex + 1)">
                                                                
                                                                <!-- 思考步骤 -->
                                                                <div v-if="step.thinking" class="reasoning-step thinking-step">
                                                                    <div class="step-header">
                                                                        <i class="el-icon-cpu"></i>
                                                                        <span class="step-title">推理思考</span>
                                                                    </div>
                                                                    <div class="step-content">
                                                                        <div v-html="formatReasoningThinking(step.thinking)"></div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- 动作步骤 -->
                                                                <div v-if="step.action" class="reasoning-step action-step">
                                                                    <div class="step-header">
                                                                        <i class="el-icon-connection"></i>
                                                                        <span class="step-title">API调用</span>
                                                                    </div>
                                                                    <div class="step-content">
                                                                        <div v-html="formatReasoningAction(step.action)"></div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- 结果步骤 -->
                                                                <div v-if="step.result" class="reasoning-step result-step">
                                                                    <div class="step-header">
                                                                        <i class="el-icon-data-analysis"></i>
                                                                        <span class="step-title">执行结果</span>
                                                                    </div>
                                                                    <div class="step-content">
                                                                        <div v-html="formatReasoningResult(step.result)"></div>
                                                                    </div>
                                                                </div>
                                                            </el-timeline-item>
                                                        </el-timeline>
                                                    </div>
                                                </div>
                                                
                                                <!-- API调用 -->
                                                <div v-if="hasApiCalls(alarm.output.res)" class="detail-section">
                                                    <h4><i class="el-icon-connection"></i> API调用</h4>
                                                    <div class="content-box">
                                                        <div v-for="(call, index) in extractApiCalls(alarm.output.res)" :key="index" class="api-call">
                                                            <i class="el-icon-arrow-right"></i>
                                                            <span v-text="call"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 推理结果对比 -->
                                                <div class="detail-section">
                                                    <h4><i class="el-icon-check"></i> 推理结果对比</h4>
                                                    <div class="result-comparison">
                                                        <div class="result-item">
                                                            <label>模型推理结果:</label>
                                                            <el-tag type="primary"><span v-text="alarm.output.model_answer_id"></span></el-tag>
                                                        </div>
                                                        <div class="result-item">
                                                            <label>真实标签:</label>
                                                            <el-tag type="info"><span v-text="alarm.input.label"></span></el-tag>
                                                        </div>
                                                        <div class="result-item">
                                                            <label>预测状态:</label>
                                                            <el-tag :type="getCorrectTagType(alarm)">
                                                                <span v-text="getCorrectText(alarm)"></span>
                                                            </el-tag>
                                                        </div>
                                                        <div class="result-item">
                                                            <label>收敛告警ID:</label>
                                                            <el-tag type="warning"><span v-text="alarm.output.model_answer.converge_alarm_id || 'N/A'"></span></el-tag>
                                                        </div>
                                                        <div class="result-item">
                                                            <label>是否保留告警:</label>
                                                            <el-tag :type="alarm.output.model_answer.keep_alarm ? 'success' : 'danger'">
                                                                <span v-text="alarm.output.model_answer.keep_alarm ? '是' : '否'"></span>
                                                            </el-tag>
                                                        </div>
                                                        <div class="result-item">
                                                            <label>聚类标签ID:</label>
                                                            <el-tag type="info"><span v-text="alarm['cluster-label-id'] || 'N/A'"></span></el-tag>
                                                        </div>
                                                        <div class="result-item">
                                                            <label>聚类答案ID:</label>
                                                            <el-tag type="info"><span v-text="alarm.output['cluster-answer-id'] || 'N/A'"></span></el-tag>
                                                        </div>
                                                        <div class="result-item">
                                                            <label>批次告警IDs:</label>
                                                            <el-tag type="info"><span v-text="(alarm.output.batch_alarm_ids || []).join(', ') || 'N/A'"></span></el-tag>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 推理思考过程 -->
                                                <div v-if="alarm.output.model_answer.thought" class="detail-section">
                                                    <h4><i class="el-icon-cpu"></i> 推理思考过程</h4>
                                                    <div class="content-box thinking-content">
                                                        <div v-html="formatThinking(alarm.output.model_answer.thought)"></div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 详细推理结果 -->
                                                <div v-if="alarm.output.model_answer.results && alarm.output.model_answer.results.length > 0" class="detail-section">
                                                    <h4><i class="el-icon-s-data"></i> 详细推理结果</h4>
                                                    <div class="results-list">
                                                        <div v-for="(result, resultIndex) in alarm.output.model_answer.results" :key="resultIndex" class="result-item-detail">
                                                            <div class="result-header">
                                                                <el-tag size="small" type="primary">
                                                                    <span v-text="'结果 ' + (resultIndex + 1)"></span>
                                                                </el-tag>
                                                                <el-tag size="small" type="success">
                                                                    <span v-text="result.convergence_type || 'N/A'"></span>
                                                                </el-tag>
                                                            </div>
                                                            <div class="result-content">
                                                                <p><strong>相关告警ID:</strong> <span v-text="result.related_alarm_id || 'N/A'"></span></p>
                                                                <p><strong>推理过程:</strong></p>
                                                                <div class="reasoning-content" v-html="formatThinking(result.reasoning || '')"></div>
                                                                <p><strong>结论:</strong></p>
                                                                <div class="conclusion-content" v-html="formatThinking(result.conclusion || '')"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- JSON结果 -->
                                                <div v-if="alarm.json_result" class="detail-section">
                                                    <h4><i class="el-icon-document"></i> JSON结果</h4>
                                                    <div class="content-box">
                                                        <el-button size="small" @click="toggleJsonResult(alarm.alarm_id)" type="text">
                                                            <i :class="expandedJsonResults[alarm.alarm_id] ? 'el-icon-arrow-up' : 'el-icon-arrow-down'"></i>
                                                            <span v-text="expandedJsonResults[alarm.alarm_id] ? '收起' : '展开'"></span> 查看JSON结果
                                                        </el-button>
                                                        <div v-show="expandedJsonResults[alarm.alarm_id]" class="json-content">
                                                            <pre v-text="alarm.json_result"></pre>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 完整提示词 -->
                                                <div class="detail-section">
                                                    <h4><i class="el-icon-document"></i> 完整提示词</h4>
                                                    <div class="content-box">
                                                        <el-button size="small" @click="togglePrompt(alarm.alarm_id)" type="text">
                                                            <i :class="expandedPrompts[alarm.alarm_id] ? 'el-icon-arrow-up' : 'el-icon-arrow-down'"></i>
                                                            <span v-text="expandedPrompts[alarm.alarm_id] ? '收起' : '展开'"></span> 查看完整提示词
                                                        </el-button>
                                                        <div v-show="expandedPrompts[alarm.alarm_id]" class="prompt-content">
                                                            <div v-html="formatSystemPrompt(alarm.input.system_prompt)"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 工程师评论 -->
                                                <div class="detail-section">
                                                    <h4><i class="el-icon-chat-dot-round"></i> 工程师评论</h4>
                                                    <div class="comments-container">
                                                        <div v-if="(alarm.comments || []).length === 0" class="no-comments">
                                                            <i class="el-icon-chat-line-round"></i>
                                                            <span>暂无评论</span>
                                                        </div>
                                                        <div v-else class="comments-list">
                                                            <div v-for="(comment, commentIndex) in alarm.comments" :key="commentIndex" class="comment-item">
                                                                <div class="comment-header">
                                                                    <span class="comment-author" v-text="comment.engineer"></span>
                                                                    <span class="comment-time" v-text="comment.timestamp"></span>
                                                                    <el-button size="mini" type="danger" @click="deleteComment(alarm.alarm_id, commentIndex)" icon="el-icon-delete">
                                                                        删除
                                                                    </el-button>
                                                                </div>
                                                                <div class="comment-content" v-text="comment.content"></div>
                                                            </div>
                                                        </div>
                                                        <div class="comment-input-container">
                                                            <el-input 
                                                                v-model="newComments[alarm.alarm_id]" 
                                                                placeholder="添加评论..."
                                                                @keyup.enter.native="addComment(alarm.alarm_id)"
                                                                class="comment-input">
                                                            </el-input>
                                                            <el-button 
                                                                @click="addComment(alarm.alarm_id)" 
                                                                type="primary" 
                                                                icon="el-icon-check"
                                                                class="comment-submit-btn">
                                                                确定
                                                            </el-button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                                </el-collapse-item>
                                            </el-collapse>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </el-card>
                    </div>
                </el-main>
            </el-container>
        </el-container>

        <!-- 导入文件对话框 -->
        <el-dialog 
            title="导入推理结果文件" 
            :visible.sync="importDialogVisible" 
            width="700px"
            :close-on-click-modal="false"
            :close-on-press-escape="false">
            <div class="import-dialog-content">
                <div class="dialog-center-content">
                    <el-alert
                        title="文件格式要求"
                        type="info"
                        :closable="false"
                        show-icon
                        class="format-alert">
                        <div slot="description">
                            <p>• 文件格式：JSON</p>
                            <p>• 必须包含：meta_data、summary、events 字段</p>
                            <p>• events 字段必须是数组格式</p>
                        </div>
                    </el-alert>
                    
                    <div class="upload-area">
                        <el-upload
                            ref="upload"
                            action="#"
                            :auto-upload="false"
                            :on-change="handleFileChange"
                            :on-remove="handleFileRemove"
                            accept=".json"
                            :limit="1"
                            :file-list="fileList"
                            drag
                            class="centered-upload">
                            <i class="el-icon-upload"></i>
                            <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                            <div class="el-upload__tip" slot="tip">只能上传JSON文件</div>
                        </el-upload>
                    </div>
                </div>
                
                <div v-if="selectedFile" class="file-info">
                    <el-card shadow="never">
                        <div slot="header">
                            <span><i class="el-icon-document"></i> 已选择文件</span>
                        </div>
                        <div class="file-details">
                            <p><strong>文件名：</strong><span v-text="selectedFile.name"></span></p>
                            <p><strong>文件大小：</strong><span v-text="(selectedFile.size / 1024).toFixed(2) + ' KB'"></span></p>
                            <p><strong>文件类型：</strong><span v-text="selectedFile.raw.type || 'application/json'"></span></p>
                        </div>
                    </el-card>
                </div>
            </div>
            <div slot="footer" class="dialog-footer">
                <el-button @click="importDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="confirmImport" :disabled="!selectedFile" icon="el-icon-check">确认导入</el-button>
            </div>
        </el-dialog>
    </div>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- 服务器传递的数据 -->
    <script>
        window.serverResultData = {{ result_data | tojson | safe }};
    </script>
    
    <script src="{{ url_for('static', filename='js/results.js') }}"></script>
</body>
</html>
